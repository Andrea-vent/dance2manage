{% extends "base.html" %}

{% block title %}Impostazioni Azienda - Dance2Manage{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-gear me-2"></i>Impostazioni Azienda</h1>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-building me-2"></i>
                    Dati Aziendali
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="denominazione_sociale" class="form-label">Denominazione Sociale *</label>
                            <input type="text" class="form-control" id="denominazione_sociale" 
                                   name="denominazione_sociale" value="{{ settings.denominazione_sociale }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="partita_iva" class="form-label">Partita IVA</label>
                            <input type="text" class="form-control" id="partita_iva" name="partita_iva" 
                                   value="{{ settings.partita_iva or '' }}" maxlength="11" 
                                   pattern="[0-9]{11}" placeholder="12345678901">
                            <div class="form-text">11 cifre (solo numeri)</div>
                        </div>
                    </div>

                    <!-- Sezione Logo -->
                    <h5 class="mt-4 mb-3 text-primary">
                        <i class="bi bi-image me-2"></i>Logo Aziendale
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="logo" class="form-label">Carica Logo</label>
                            <input type="file" class="form-control" id="logo" name="logo" 
                                   accept="image/*" onchange="previewLogo(this)">
                            <div class="form-text">
                                Formati supportati: JPG, PNG, GIF. Dimensione consigliata: 300x300px max
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Anteprima Logo</label>
                            <div class="border rounded p-2 text-center" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                {% if settings.logo_filename %}
                                <img id="logoPreview" src="{{ url_for('static', filename='uploads/' + settings.logo_filename) }}" 
                                     alt="Logo" style="max-width: 100px; max-height: 100px; object-fit: contain;">
                                {% else %}
                                <img id="logoPreview" src="#" alt="Nessun logo" 
                                     style="max-width: 100px; max-height: 100px; object-fit: contain; display: none;">
                                <span id="noLogoText" class="text-muted">Nessun logo caricato</span>
                                {% endif %}
                            </div>
                            {% if settings.logo_filename %}
                            <div class="mt-2">
                                <small class="text-muted">File: {{ settings.logo_filename }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sezione Configurazione Email -->
                    <h5 class="mt-4 mb-3 text-primary">
                        <i class="bi bi-envelope-gear me-2"></i>Configurazione Email/SMTP
                        <small class="text-muted fs-6 ms-2">
                            {% if settings.mail_configured %}
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Configurata</span>
                            {% else %}
                                <span class="badge bg-warning"><i class="bi bi-exclamation-triangle me-1"></i>Non configurata</span>
                            {% endif %}
                        </small>
                    </h5>
                    
                    <div class="alert alert-info border-0 mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong>Configurazione Email:</strong> Configura i parametri SMTP per l'invio di email automatiche.<br>
                                <small class="text-muted">
                                    <strong>Provider comuni:</strong><br>
                                    • Gmail: smtp.gmail.com:587 (usa App Password)<br>
                                    • Outlook: smtp-mail.outlook.com:587<br>
                                    • Mailtrap: sandbox.smtp.mailtrap.io:2525 (username alfanumerico)<br>
                                    • SendGrid: smtp.sendgrid.net:587 (API key come username)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Provider Preset -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="smtp_preset" class="form-label">Configurazione Rapida</label>
                            <select class="form-select" id="smtp_preset" name="smtp_preset">
                                <option value="">Seleziona un provider o configura manualmente</option>
                                <option value="gmail">Gmail (smtp.gmail.com:587 TLS)</option>
                                <option value="outlook">Outlook (smtp-mail.outlook.com:587 TLS)</option>
                                <option value="yahoo">Yahoo (smtp.mail.yahoo.com:587 TLS)</option>
                                <option value="mailtrap">Mailtrap (sandbox.smtp.mailtrap.io:2525 TLS)</option>
                                <option value="sendgrid">SendGrid (smtp.sendgrid.net:587 TLS)</option>
                                <option value="mailgun">Mailgun (smtp.mailgun.org:587 TLS)</option>
                                <option value="amazon_ses">Amazon SES (email-smtp.us-east-1.amazonaws.com:587 TLS)</option>
                            </select>
                            <div class="form-text">Seleziona per configurazione automatica o lascia vuoto per configurazione manuale</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="mail_server" class="form-label">Server SMTP</label>
                            <input type="text" class="form-control" id="mail_server" name="mail_server" 
                                   value="{{ settings.mail_server or '' }}" placeholder="smtp.gmail.com">
                            <div class="form-text">Indirizzo del server SMTP del tuo provider email</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="mail_port" class="form-label">Porta SMTP</label>
                            <select class="form-select" id="mail_port" name="mail_port">
                                <option value="587" {% if settings.mail_port == 587 %}selected{% endif %}>587 (TLS - Consigliato)</option>
                                <option value="465" {% if settings.mail_port == 465 %}selected{% endif %}>465 (SSL)</option>
                                <option value="25" {% if settings.mail_port == 25 %}selected{% endif %}>25 (Non cifrato)</option>
                                <option value="2525" {% if settings.mail_port == 2525 %}selected{% endif %}>2525 (Alternativo)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mail_username" class="form-label">Username SMTP</label>
                            <input type="text" class="form-control" id="mail_username" name="mail_username" 
                                   value="{{ settings.mail_username or '' }}" placeholder="username o tuo@email.com">
                            <div class="form-text">Email, username alfanumerico o API key (dipende dal provider)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mail_password" class="form-label">Password/Token SMTP</label>
                            <input type="password" class="form-control" id="mail_password" name="mail_password" 
                                   value="{{ settings.mail_password or '' }}" placeholder="Password, App Password o API key">
                            <div class="form-text">Password account, App Password (Gmail/Outlook) o API key (SendGrid/Mailtrap)</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mail_default_sender" class="form-label">Email Mittente</label>
                            <input type="email" class="form-control" id="mail_default_sender" name="mail_default_sender" 
                                   value="{{ settings.mail_default_sender or '' }}" placeholder="noreply@scuoladanza.it">
                            <div class="form-text">Email che apparirà come mittente nelle email inviate</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mail_max_emails" class="form-label">Limite Email per Connessione</label>
                            <input type="number" class="form-control" id="mail_max_emails" name="mail_max_emails" 
                                   value="{{ settings.mail_max_emails or 100 }}" min="1" max="1000">
                            <div class="form-text">Numero massimo di email per connessione SMTP</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mail_use_tls" name="mail_use_tls" 
                                       {% if settings.mail_use_tls %}checked{% endif %}>
                                <label class="form-check-label" for="mail_use_tls">
                                    Usa TLS (Consigliato)
                                </label>
                                <div class="form-text">Crittografia TLS per sicurezza</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mail_use_ssl" name="mail_use_ssl" 
                                       {% if settings.mail_use_ssl %}checked{% endif %}>
                                <label class="form-check-label" for="mail_use_ssl">
                                    Usa SSL
                                </label>
                                <div class="form-text">Crittografia SSL alternativa</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mail_suppress_send" name="mail_suppress_send" 
                                       {% if settings.mail_suppress_send %}checked{% endif %}>
                                <label class="form-check-label" for="mail_suppress_send">
                                    Modalità Test
                                </label>
                                <div class="form-text">Disabilita invio reale (per test)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pulsante Test Email -->
                    <div class="row mt-3 mb-4">
                        <div class="col-12">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><i class="bi bi-envelope-check me-2"></i>Test Configurazione Email</h6>
                                            <small class="text-muted">Invia un'email di test per verificare che la configurazione SMTP funzioni</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="email" id="testEmailAddress" class="form-control form-control-sm" 
                                                   placeholder="Email destinatario" style="width: 200px;" 
                                                   value="{{ current_user.email if current_user else '' }}">
                                            <button type="button" id="testEmailBtn" class="btn btn-outline-primary btn-sm"
                                                    {% if not settings.mail_configured %}disabled{% endif %}>
                                                <i class="bi bi-send me-1"></i>Invia Test
                                            </button>
                                        </div>
                                    </div>
                                    {% if not settings.mail_configured %}
                                    <div class="mt-2">
                                        <small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Completa prima la configurazione SMTP per abilitare il test</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 text-primary">
                        <i class="bi bi-building me-2"></i>Indirizzo Aziendale
                    </h5>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="indirizzo" class="form-label">Indirizzo</label>
                            <input type="text" class="form-control" id="indirizzo" name="indirizzo" 
                                   value="{{ settings.indirizzo or '' }}" placeholder="Via Roma, 123">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cap" class="form-label">CAP</label>
                            <input type="text" class="form-control" id="cap" name="cap" 
                                   value="{{ settings.cap or '' }}" maxlength="5" 
                                   pattern="[0-9]{5}" placeholder="00100">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="citta" class="form-label">Città</label>
                            <input type="text" class="form-control" id="citta" name="citta" 
                                   value="{{ settings.citta or '' }}" placeholder="Roma">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="provincia" class="form-label">Provincia</label>
                            <input type="text" class="form-control" id="provincia" name="provincia" 
                                   value="{{ settings.provincia or '' }}" maxlength="2" 
                                   style="text-transform: uppercase;" placeholder="RM">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">Telefono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" 
                                   value="{{ settings.telefono or '' }}" placeholder="06 12345678">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ settings.email or '' }}" placeholder="info@scuoladanza.it">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sito_web" class="form-label">Sito Web</label>
                            <input type="url" class="form-control" id="sito_web" name="sito_web" 
                                   value="{{ settings.sito_web or '' }}" placeholder="https://www.scuoladanza.it">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="codice_fiscale" class="form-label">Codice Fiscale</label>
                            <input type="text" class="form-control" id="codice_fiscale" name="codice_fiscale" 
                                   value="{{ settings.codice_fiscale or '' }}" maxlength="16" 
                                   pattern="[A-Za-z0-9]{16}" style="text-transform: uppercase;" 
                                   placeholder="RSSMRA80A01H501X">
                        </div>
                    </div>

                    <!-- Sezione Numerazione Ricevute - Visibile solo se non sono ancora state emesse ricevute -->
                    {% if not settings.ricevute_gia_emesse() %}
                    <h5 class="mt-4 mb-3 text-primary">
                        <i class="bi bi-receipt me-2"></i>Numerazione Ricevute - Prima Configurazione
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="numero_ricevuta_iniziale" class="form-label">Numero Ricevuta Iniziale *</label>
                            <input type="number" class="form-control" id="numero_ricevuta_iniziale" 
                                   name="numero_ricevuta_iniziale" value="{{ settings.numero_ricevuta_iniziale or 1 }}" 
                                   min="1" max="999999" required>
                            <div class="form-text">Numero da cui iniziare la numerazione delle ricevute (solo per il primo anno di utilizzo)</div>
                        </div>
                        <div class="col-md-8 mb-3">
                            <div class="card bg-warning bg-opacity-10 border-warning">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-warning mb-2">
                                        <i class="bi bi-exclamation-triangle-fill me-1"></i>Configurazione Prima Emissione
                                    </h6>
                                    <ul class="small mb-0 text-dark">
                                        <li><strong>⚠️ ATTENZIONE:</strong> Una volta emessa la prima ricevuta, questo numero NON potrà più essere modificato</li>
                                        <li><strong>Primo utilizzo:</strong> Il numero iniziale si applica solo quando attivi per la prima volta il sistema</li>
                                        <li><strong>Reset annuale:</strong> Dal secondo anno in poi, ogni 1° gennaio la numerazione riparte sempre da 1</li>
                                        <li><strong>Integrità contabile:</strong> Per garantire la continuità numerica, la configurazione si bloccherà dopo il primo utilizzo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Sezione informativa per sistema già in uso -->
                    <div class="alert alert-success mt-4" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle-fill me-2"></i>Sistema di Numerazione Ricevute Attivo
                        </h6>
                        <p class="mb-2">Il sistema di numerazione automatica delle ricevute è già operativo.</p>
                        <hr>
                        <p class="mb-0">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Numero iniziale configurato:</strong> {{ settings.numero_ricevuta_iniziale }}<br>
                                <i class="bi bi-shield-check me-1"></i>
                                <strong>Stato:</strong> Configurazione bloccata per integrità contabile
                            </small>
                        </p>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="note" class="form-label">Note aggiuntive</label>
                        <textarea class="form-control" id="note" name="note" rows="3" 
                                  placeholder="Note aggiuntive, informazioni extra, ecc.">{{ settings.note or '' }}</textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Torna alla Dashboard
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Salva Impostazioni
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview dati -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-eye me-2"></i>Anteprima Dati
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>{{ settings.denominazione_sociale }}</strong><br>
                        {% if settings.indirizzo_completo %}
                            {{ settings.indirizzo_completo }}<br>
                        {% endif %}
                        {% if settings.telefono %}
                            Tel: {{ settings.telefono }}<br>
                        {% endif %}
                        {% if settings.email %}
                            Email: {{ settings.email }}<br>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if settings.partita_iva %}
                            <strong>P.IVA:</strong> {{ settings.partita_iva }}<br>
                        {% endif %}
                        {% if settings.codice_fiscale %}
                            <strong>C.F.:</strong> {{ settings.codice_fiscale }}<br>
                        {% endif %}
                        {% if settings.sito_web %}
                            <strong>Web:</strong> <a href="{{ settings.sito_web }}" target="_blank">{{ settings.sito_web }}</a>
                        {% endif %}
                    </div>
                </div>
                {% if settings.note %}
                <hr>
                <small class="text-muted">{{ settings.note }}</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewLogo(input) {
    const preview = document.getElementById('logoPreview');
    const noLogoText = document.getElementById('noLogoText');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (noLogoText) noLogoText.style.display = 'none';
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

// Validazione form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const fileInput = document.getElementById('logo');
    
    form.addEventListener('submit', function(e) {
        // Validazione file logo
        if (fileInput.files[0]) {
            const file = fileInput.files[0];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (file.size > maxSize) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'File troppo grande',
                    text: 'Il file logo è troppo grande. Dimensione massima: 5MB',
                    confirmButtonColor: '#dc3545'
                });
                return false;
            }
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Formato non supportato',
                    text: 'Formato file non supportato. Usa: JPG, PNG o GIF',
                    confirmButtonColor: '#dc3545'
                });
                return false;
            }
        }
    });
    
    // Gestione test email
    const testEmailBtn = document.getElementById('testEmailBtn');
    const testEmailAddress = document.getElementById('testEmailAddress');
    
    if (testEmailBtn) {
        testEmailBtn.addEventListener('click', function() {
            const email = testEmailAddress.value.trim();
            
            if (!email) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Email richiesta',
                    text: 'Inserisci un indirizzo email per il test',
                    confirmButtonColor: '#0d6efd'
                }).then(() => {
                    testEmailAddress.focus();
                });
                return;
            }
            
            // Disabilita pulsante durante il test
            testEmailBtn.disabled = true;
            testEmailBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Invio in corso...';
            
            // Trova il token CSRF
            const csrfToken = document.querySelector('input[name="csrf_token"]');
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (csrfToken && csrfToken.value) {
                headers['X-CSRFToken'] = csrfToken.value;
            }
            
            // Chiamata AJAX per test email
            fetch('/settings/test-email', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success toast
                    if (typeof toastr !== 'undefined') {
                        toastr.success(data.message, 'Test Email Completato');
                    } else {
                        Swal.fire({
                            icon: 'success',
                            title: 'Test Email Completato',
                            text: data.message,
                            confirmButtonColor: '#198754'
                        });
                    }
                } else {
                    // Error toast
                    if (typeof toastr !== 'undefined') {
                        toastr.error(data.message, 'Errore Test Email');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Errore Test Email',
                            text: data.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Errore test email:', error);
                const errorMsg = 'Errore durante il test email: ' + error.message;
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg, 'Errore di Rete');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Errore di Rete',
                        text: errorMsg,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .finally(() => {
                // Ripristina pulsante
                testEmailBtn.disabled = false;
                testEmailBtn.innerHTML = '<i class="bi bi-send me-1"></i>Invia Test';
            });
        });
    }
    
    // Auto-abilita/disabilita test button quando cambiano le impostazioni email
    const emailInputs = [
        'mail_server', 'mail_username', 'mail_password', 'mail_default_sender'
    ];
    
    emailInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                updateTestButtonState();
            });
        } else {
            console.warn(`Campo email con ID '${inputId}' non trovato nel DOM`);
        }
    });
    
    // Gestione preset SMTP
    const smtpPreset = document.getElementById('smtp_preset');
    if (smtpPreset) {
        smtpPreset.addEventListener('change', function() {
            const preset = this.value;
            if (!preset) return;
            
            const presets = {
                gmail: {
                    server: 'smtp.gmail.com',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'tuo@gmail.com',
                    placeholder_password: 'App Password (non la password normale)'
                },
                outlook: {
                    server: 'smtp-mail.outlook.com',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'tuo@outlook.com',
                    placeholder_password: 'Password del tuo account'
                },
                yahoo: {
                    server: 'smtp.mail.yahoo.com',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'tuo@yahoo.com',
                    placeholder_password: 'App Password'
                },
                mailtrap: {
                    server: 'sandbox.smtp.mailtrap.io',
                    port: 2525,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'username alfanumerico',
                    placeholder_password: 'password da Mailtrap'
                },
                sendgrid: {
                    server: 'smtp.sendgrid.net',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'apikey',
                    placeholder_password: 'La tua SendGrid API key'
                },
                mailgun: {
                    server: 'smtp.mailgun.org',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'postmaster@tuodominio.mailgun.org',
                    placeholder_password: 'Password da Mailgun'
                },
                amazon_ses: {
                    server: 'email-smtp.us-east-1.amazonaws.com',
                    port: 587,
                    tls: true,
                    ssl: false,
                    placeholder_username: 'Access Key ID',
                    placeholder_password: 'Secret Access Key'
                }
            };
            
            const config = presets[preset];
            if (config) {
                // Aggiorna i campi con la configurazione preset
                document.getElementById('mail_server').value = config.server;
                document.getElementById('mail_port').value = config.port;
                document.getElementById('mail_use_tls').checked = config.tls;
                document.getElementById('mail_use_ssl').checked = config.ssl;
                
                // Aggiorna placeholder per guidare l'utente
                document.getElementById('mail_username').placeholder = config.placeholder_username;
                document.getElementById('mail_password').placeholder = config.placeholder_password;
                
                // Aggiorna stato del pulsante test
                updateTestButtonState();
            }
        });
    }
    
    // Inizializza lo stato del pulsante test
    updateTestButtonState();
    
    function updateTestButtonState() {
        if (!testEmailBtn) return; // Pulsante non esistente
        
        const serverEl = document.getElementById('mail_server');
        const usernameEl = document.getElementById('mail_username');
        const passwordEl = document.getElementById('mail_password');
        const senderEl = document.getElementById('mail_default_sender');
        
        // Controlla se tutti gli elementi esistono
        if (!serverEl || !usernameEl || !passwordEl || !senderEl) {
            console.warn('Alcuni campi email non sono stati trovati nel DOM');
            return;
        }
        
        const server = serverEl.value.trim();
        const username = usernameEl.value.trim();
        const password = passwordEl.value.trim();
        const sender = senderEl.value.trim();
        
        const isConfigured = server && username && password && sender;
        testEmailBtn.disabled = !isConfigured;
        
        if (!isConfigured) {
            testEmailBtn.title = 'Completa prima la configurazione SMTP';
        } else {
            testEmailBtn.title = 'Invia email di test';
        }
    }
});
</script>
{% endblock %}
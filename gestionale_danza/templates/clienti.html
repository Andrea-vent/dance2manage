{% extends "base.html" %}

{% block title %}Clienti - Gestionale Scuola di Danza{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-people me-2"></i>Clienti</h1>
            <div>
                <button type="button" class="btn btn-success me-2" onclick="mostraGeneraRicevute()" 
                        id="btnGeneraRicevute" style="display: none;">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Genera Ricevute
                </button>
                <a href="{{ url_for('nuovo_cliente') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i>Nuovo Cliente
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtri di ricerca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3" id="searchForm">
                    <div class="col-md-4">
                        <label for="search" class="form-label">Ricerca Live</label>
                        <input type="text" class="form-control" id="searchLive" 
                               value="{{ search }}" placeholder="Nome, cognome, email, telefono, codice fiscale...">
                        <input type="hidden" id="search" name="search" value="{{ search }}">
                    </div>
                    <div class="col-md-3">
                        <label for="stato" class="form-label">Stato</label>
                        <select class="form-select" id="stato" name="stato">
                            <option value="tutti" {% if stato == 'tutti' %}selected{% endif %}>Tutti</option>
                            <option value="attivi" {% if stato == 'attivi' %}selected{% endif %}>Attivi</option>
                            <option value="inattivi" {% if stato == 'inattivi' %}selected{% endif %}>Inattivi</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="per_page" class="form-label">Elementi per pagina</label>
                        <select class="form-select" id="per_page" name="per_page" onchange="changePagination()">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-search me-1"></i>Cerca
                            </button>
                        </div>
                    </div>
                    <!-- Reset alla pagina 1 quando si cambia filtro -->
                    <input type="hidden" name="page" value="1">
                    <input type="hidden" name="sort_by" value="{{ sort_by }}">
                    <input type="hidden" name="sort_order" value="{{ sort_order }}">
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lista clienti -->
<div class="row">
    <div class="col-12">
        {% if clienti.items %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onclick="toggleAllClienti()">
                        </th>
                        <th class="sortable-header" onclick="sortTable('cognome')">
                            Nome
                            {% if sort_by == 'cognome' %}
                                <i class="bi bi-chevron-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                            {% else %}
                                <i class="bi bi-chevron-expand text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" onclick="sortTable('codice_fiscale')">
                            Codice Fiscale
                            {% if sort_by == 'codice_fiscale' %}
                                <i class="bi bi-chevron-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                            {% else %}
                                <i class="bi bi-chevron-expand text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" onclick="sortTable('telefono')">
                            Telefono
                            {% if sort_by == 'telefono' %}
                                <i class="bi bi-chevron-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                            {% else %}
                                <i class="bi bi-chevron-expand text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" onclick="sortTable('email')">
                            Email
                            {% if sort_by == 'email' %}
                                <i class="bi bi-chevron-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                            {% else %}
                                <i class="bi bi-chevron-expand text-muted"></i>
                            {% endif %}
                        </th>
                        <th>Corsi</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in clienti.items %}
                    <tr class="{% if not cliente.attivo %}text-muted{% endif %}">
                        <td>
                            <input type="checkbox" class="cliente-checkbox" value="{{ cliente.id }}" 
                                   onchange="toggleGeneraRicevuteBtn()" data-nome="{{ cliente.nome_completo }}">
                        </td>
                        <td>
                            <strong>{{ cliente.nome_completo }}</strong>
                        </td>
                        <td>{{ cliente.codice_fiscale or '-' }}</td>
                        <td>{{ cliente.telefono or '-' }}</td>
                        <td>{{ cliente.email or '-' }}</td>
                        <td>
                            {% if cliente.corsi %}
                                {% for corso in cliente.corsi %}
                                    <span class="badge bg-info me-1">{{ corso.nome }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">Nessun corso</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cliente.attivo %}
                                <span class="badge bg-success">Attivo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inattivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('dettagli_cliente', id=cliente.id) }}" 
                                   class="btn btn-outline-info" title="Visualizza">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('modifica_cliente', id=cliente.id) }}" 
                                   class="btn btn-outline-primary" title="Modifica">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="confermaEliminazione('{{ cliente.nome_completo }}', '{{ url_for('elimina_cliente', id=cliente.id) }}')"
                                        title="Elimina">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginazione -->
        {% if clienti.pages > 1 %}
        <nav aria-label="Navigazione clienti" class="mt-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        Mostra {{ clienti.per_page * (clienti.page - 1) + 1 }} - 
                        {{ clienti.per_page * (clienti.page - 1) + clienti.items|length }} di 
                        {{ clienti.total }} clienti
                        {% if search or stato != 'tutti' %}(filtrati){% endif %}
                    </small>
                </div>
                <div class="col-md-6">
                    <ul class="pagination pagination-sm justify-content-end mb-0">
                        {% if clienti.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('clienti', page=clienti.prev_num, search=search, stato=stato, per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                        </li>
                        {% endif %}
                        
                        {% for page_num in clienti.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num != clienti.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('clienti', page=page_num, search=search, stato=stato, per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if clienti.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('clienti', page=clienti.next_num, search=search, stato=stato, per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        {% else %}
        <div class="mt-3">
            <small class="text-muted">
                Totale: {{ clienti.total }} clienti
                {% if search or stato != 'tutti' %}(filtrati){% endif %}
            </small>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
            <h3 class="text-muted mt-3">Nessun cliente trovato</h3>
            {% if search or stato != 'tutti' %}
                <p class="text-muted">Prova a modificare i filtri di ricerca</p>
                <a href="{{ url_for('clienti') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise me-1"></i>Azzera filtri
                </a>
            {% else %}
                <p class="text-muted">Inizia aggiungendo il primo cliente</p>
                <a href="{{ url_for('nuovo_cliente') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i>Aggiungi Cliente
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal di conferma eliminazione -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare il cliente <strong id="clienteNome"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <strong>Attenzione:</strong> Questa azione eliminerà anche tutti i pagamenti associati.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Genera Ricevute -->
<div class="modal fade" id="modalGeneraRicevute" tabindex="-1" aria-labelledby="modalGeneraRicevuteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGeneraRicevuteLabel">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Genera Ricevute
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('genera_ricevute_bulk') }}" method="POST" id="formGeneraRicevute">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mese_ricevuta" class="form-label">Mese</label>
                            <select class="form-select" id="mese_ricevuta" name="mese" required>
                                {% set mesi = [
                                    (1, 'Gennaio'), (2, 'Febbraio'), (3, 'Marzo'), (4, 'Aprile'),
                                    (5, 'Maggio'), (6, 'Giugno'), (7, 'Luglio'), (8, 'Agosto'),
                                    (9, 'Settembre'), (10, 'Ottobre'), (11, 'Novembre'), (12, 'Dicembre')
                                ] %}
                                {% for num, nome in mesi %}
                                <option value="{{ num }}">{{ nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="anno_ricevuta" class="form-label">Anno</label>
                            <select class="form-select" id="anno_ricevuta" name="anno" required>
                                {% for anno in range(2024, 2027) %}
                                <option value="{{ anno }}">{{ anno }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Clienti selezionati:</label>
                        <div id="clientiSelezionati" class="border rounded p-3 bg-light">
                            <!-- Popolato via JavaScript -->
                        </div>
                    </div>
                    
                    <div id="dettagliCorsi" class="mb-3" style="display: none;">
                        <label class="form-label">Corsi che verranno fatturati:</label>
                        <div id="corsiElenco" class="border rounded p-3 bg-light">
                            <!-- Popolato via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Nota:</strong> Verranno create ricevute per tutti i corsi attivi di ogni cliente selezionato. 
                        Il metodo di pagamento sarà impostato su "Contanti" (modificabile successivamente).
                        <br><small class="text-muted">I clienti non iscritti a nessun corso verranno ignorati.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Genera Ricevute
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.sortable-header {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.sortable-header:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

.sortable-header i {
    font-size: 0.8em;
    margin-left: 4px;
}

#searchLive {
    border: 2px solid #dee2e6;
    transition: border-color 0.2s ease;
}

#searchLive:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.search-loading {
    border-color: #ffc107 !important;
}
</style>

<script>
function confermaEliminazione(nomeCliente, url) {
    document.getElementById('clienteNome').textContent = nomeCliente;
    document.getElementById('deleteForm').action = url;
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}

function changePagination() {
    // Reset alla pagina 1 quando si cambia il numero di elementi per pagina
    const form = document.getElementById('searchForm');
    const hiddenPage = form.querySelector('input[name="page"]');
    hiddenPage.value = '1';
    form.submit();
}

// Migliora l'UX della ricerca con debounce
let searchTimeout;
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('searchForm').submit();
    }, 400); // Attendi 400ms prima di sottomettere
});

// Auto-submit quando cambia lo stato
document.getElementById('stato').addEventListener('change', function() {
    document.getElementById('searchForm').submit();
});

// === FUNZIONI PER RICERCA LIVE E ORDINAMENTO ===

let liveSearchTimeout;
const searchInput = document.getElementById('searchLive');
const searchForm = document.getElementById('searchForm');

// Ricerca live con debouncing migliorato
searchInput.addEventListener('input', function() {
    clearTimeout(liveSearchTimeout);
    
    const searchValue = this.value;
    
    // Aggiungi classe di loading
    this.classList.add('search-loading');
    
    liveSearchTimeout = setTimeout(() => {
        // Aggiorna il campo hidden
        document.getElementById('search').value = searchValue;
        
        // Reset alla pagina 1
        document.querySelector('input[name="page"]').value = '1';
        
        // Submit del form
        searchForm.submit();
    }, 400); // 400ms di debouncing
});

// Funzione per ordinamento colonne
function sortTable(column) {
    const currentSortBy = '{{ sort_by }}';
    const currentSortOrder = '{{ sort_order }}';
    
    let newSortOrder = 'asc';
    
    // Se stiamo cliccando sulla stessa colonna, invertiamo l'ordine
    if (currentSortBy === column) {
        newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
    }
    
    // Aggiorna i valori hidden
    document.querySelector('input[name="sort_by"]').value = column;
    document.querySelector('input[name="sort_order"]').value = newSortOrder;
    document.querySelector('input[name="page"]').value = '1'; // Reset alla pagina 1
    
    // Submit del form
    searchForm.submit();
}

// Migliora il feedback visivo durante il caricamento
searchForm.addEventListener('submit', function() {
    // Disabilita il form per evitare submit multipli
    const buttons = this.querySelectorAll('button, input[type="submit"]');
    buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.innerHTML.includes('Cerca')) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cercando...';
        }
    });
});

// Ripristina il form se si torna indietro
window.addEventListener('pageshow', function() {
    const buttons = searchForm.querySelectorAll('button, input[type="submit"]');
    buttons.forEach(btn => {
        btn.disabled = false;
        if (btn.innerHTML.includes('Cercando')) {
            btn.innerHTML = '<i class="bi bi-search me-1"></i>Cerca';
        }
    });
    
    // Rimuovi classe loading dalla ricerca
    searchInput.classList.remove('search-loading');
});

// === FUNZIONI PER GENERAZIONE RICEVUTE BULK ===

function toggleAllClienti() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.cliente-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    toggleGeneraRicevuteBtn();
}

function toggleGeneraRicevuteBtn() {
    const checkboxes = document.querySelectorAll('.cliente-checkbox:checked');
    const btn = document.getElementById('btnGeneraRicevute');
    
    if (checkboxes.length > 0) {
        btn.style.display = 'inline-block';
        btn.innerHTML = `<i class="bi bi-file-earmark-pdf me-1"></i>Genera Ricevute (${checkboxes.length})`;
    } else {
        btn.style.display = 'none';
    }
}

function mostraGeneraRicevute() {
    const checkboxes = document.querySelectorAll('.cliente-checkbox:checked');
    const clientiDiv = document.getElementById('clientiSelezionati');
    
    // Popola la lista dei clienti selezionati
    clientiDiv.innerHTML = '';
    checkboxes.forEach(checkbox => {
        const nome = checkbox.getAttribute('data-nome');
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2 mb-1';
        badge.textContent = nome;
        clientiDiv.appendChild(badge);
        
        // Aggiungi input hidden per il form
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'clienti_ids';
        hiddenInput.value = checkbox.value;
        document.getElementById('formGeneraRicevute').appendChild(hiddenInput);
    });
    
    // Imposta mese e anno corrente come default
    const now = new Date();
    document.getElementById('mese_ricevuta').value = now.getMonth() + 1;
    document.getElementById('anno_ricevuta').value = now.getFullYear();
    
    // Mostra il modal
    new bootstrap.Modal(document.getElementById('modalGeneraRicevute')).show();
}

// Pulisci input hidden quando il modal si chiude
document.getElementById('modalGeneraRicevute').addEventListener('hidden.bs.modal', function() {
    const hiddenInputs = document.querySelectorAll('input[name="clienti_ids"]');
    hiddenInputs.forEach(input => input.remove());
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Pagamenti - Gestionale Scuola di Danza{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-credit-card me-2"></i>Pagamenti</h1>
            <a href="{{ url_for('nuovo_pagamento') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Nuovo Pagamento
            </a>
        </div>
    </div>
</div>

<!-- Filtri -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="mese" class="form-label">Mese</label>
                        <select class="form-select" id="mese" name="mese">
                            <option value="">Tutti</option>
                            {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if mese_filtro == i %}selected{% endif %}>
                                {% set mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'] %}
                                {{ mesi[i] }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="anno" class="form-label">Anno</label>
                        <select class="form-select" id="anno" name="anno">
                            <option value="">Tutti</option>
                            {% for anno in range(2020, 2030) %}
                            <option value="{{ anno }}" {% if anno_filtro == anno %}selected{% endif %}>{{ anno }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="cliente_id" class="form-label">Cliente</label>
                        <select class="form-select" id="cliente_id" name="cliente_id">
                            <option value="">Tutti i clienti</option>
                            {% for cliente in clienti %}
                            <option value="{{ cliente.id }}" {% if cliente_filtro == cliente.id %}selected{% endif %}>
                                {{ cliente.nome_completo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="corso_id" class="form-label">Corso</label>
                        <select class="form-select" id="corso_id" name="corso_id">
                            <option value="">Tutti i corsi</option>
                            {% for corso in corsi %}
                            <option value="{{ corso.id }}" {% if corso_filtro == corso.id %}selected{% endif %}>
                                {{ corso.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-search me-1"></i>Filtra
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Statistiche rapide -->
{% if pagamenti %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>€{{ "%.2f"|format(pagamenti|selectattr('pagato')|map(attribute='importo')|sum) }}</h4>
                <p class="mb-0">Incassato</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4>€{{ "%.2f"|format(pagamenti|rejectattr('pagato')|map(attribute='importo')|sum) }}</h4>
                <p class="mb-0">Da incassare</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>€{{ "%.2f"|format(pagamenti|map(attribute='importo')|sum) }}</h4>
                <p class="mb-0">Totale</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Lista pagamenti -->
<div class="row">
    <div class="col-12">
        {% if pagamenti %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Periodo</th>
                        <th>Cliente</th>
                        <th>Corso</th>
                        <th>Importo</th>
                        <th>Stato</th>
                        <th>Data Pagamento</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pagamento in pagamenti %}
                    <tr class="{% if not pagamento.pagato %}table-warning{% endif %}">
                        <td>{{ pagamento.periodo }}</td>
                        <td>{{ pagamento.cliente.nome_completo }}</td>
                        <td>{{ pagamento.corso.nome }}</td>
                        <td><strong>€{{ "%.2f"|format(pagamento.importo) }}</strong></td>
                        <td>
                            {% if pagamento.pagato %}
                                <span class="badge bg-success">Pagato</span>
                            {% else %}
                                <span class="badge bg-danger">Non Pagato</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pagamento.data_pagamento %}
                                {{ pagamento.data_pagamento.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                {% if not pagamento.pagato %}
                                <form method="POST" action="{{ url_for('marca_pagato', id=pagamento.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-outline-success" title="Marca come pagato">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                </form>
                                {% endif %}
                                
                                {% if pagamento.pagato %}
                                <a href="{{ url_for('genera_ricevuta', id=pagamento.id) }}" 
                                   class="btn btn-outline-info" title="Genera ricevuta">
                                    <i class="bi bi-file-pdf"></i>
                                </a>
                                {% endif %}
                                
                                <a href="{{ url_for('modifica_pagamento', id=pagamento.id) }}" 
                                   class="btn btn-outline-primary" title="Modifica">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="confermaEliminazione('{{ pagamento.periodo }} - {{ pagamento.cliente.nome_completo }}', '{{ url_for('elimina_pagamento', id=pagamento.id) }}')"
                                        title="Elimina">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <small class="text-muted">
                Trovati {{ pagamenti|length }} pagamenti
                {% if mese_filtro or anno_filtro or cliente_filtro or corso_filtro %}
                    (filtrati)
                {% endif %}
            </small>
        </div>

        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-credit-card text-muted" style="font-size: 4rem;"></i>
            <h3 class="text-muted mt-3">Nessun pagamento trovato</h3>
            {% if mese_filtro or anno_filtro or cliente_filtro or corso_filtro %}
                <p class="text-muted">Prova a modificare i filtri di ricerca</p>
                <a href="{{ url_for('pagamenti') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise me-1"></i>Azzera filtri
                </a>
            {% else %}
                <p class="text-muted">Inizia registrando il primo pagamento</p>
                <a href="{{ url_for('nuovo_pagamento') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Nuovo Pagamento
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal di conferma eliminazione -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare il pagamento <strong id="pagamentoInfo"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <strong>Attenzione:</strong> Questa azione è irreversibile.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confermaEliminazione(pagamentoInfo, url) {
    document.getElementById('pagamentoInfo').textContent = pagamentoInfo;
    document.getElementById('deleteForm').action = url;
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}
</script>
{% endblock %}